<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Substitution Finder</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; color: #1a1a2e; min-height: 100vh; }

    .header { background: #1a1a2e; color: #fff; padding: 1.25rem 2rem; display: flex; align-items: center; gap: 0.75rem; }
    .header h1 { font-size: 1.35rem; font-weight: 600; }
    .header span { font-size: 0.85rem; opacity: 0.6; }

    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1.5rem; }

    .form-card { background: #fff; border-radius: 12px; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .form-card h2 { font-size: 1.1rem; margin-bottom: 1.5rem; color: #1a1a2e; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.35rem; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label { font-size: 0.8rem; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.03em; }
    .form-group input, .form-group select, .form-group textarea {
      padding: 0.6rem 0.75rem; border: 1.5px solid #ddd; border-radius: 8px;
      font-size: 0.95rem; transition: border-color 0.2s; font-family: inherit;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #4361ee; }
    .form-group textarea { resize: vertical; min-height: 60px; }

    .btn { padding: 0.7rem 2rem; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #4361ee; color: #fff; margin-top: 1.25rem; }
    .btn-primary:hover { background: #3a56d4; }
    .btn-primary:disabled { background: #a0aec0; cursor: not-allowed; }

    .loading { display: none; align-items: center; gap: 0.75rem; margin-top: 1.5rem; color: #555; }
    .loading.active { display: flex; }
    .spinner { width: 22px; height: 22px; border: 3px solid #e2e8f0; border-top-color: #4361ee; border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .results { margin-top: 2rem; }
    .results-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.25rem; }
    .results-header h2 { font-size: 1.1rem; }
    .source-badge { display: inline-block; background: #e8edff; color: #4361ee; padding: 0.3rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
    .meta-line { font-size: 0.82rem; color: #888; margin-bottom: 1rem; }

    .sub-card {
      background: #fff; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #4361ee;
      display: grid; grid-template-columns: auto 1fr auto; gap: 1rem; align-items: start;
    }
    .rank-badge {
      width: 36px; height: 36px; border-radius: 50%; background: #4361ee; color: #fff;
      display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem;
    }
    .sub-info h3 { font-size: 1rem; margin-bottom: 0.25rem; }
    .sub-meta { font-size: 0.8rem; color: #888; margin-bottom: 0.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .sub-meta .tag { background: #f1f3f5; padding: 0.15rem 0.5rem; border-radius: 4px; }
    .sub-reason { font-size: 0.88rem; color: #444; line-height: 1.5; margin-bottom: 0.5rem; }
    .sub-notes { font-size: 0.82rem; color: #666; background: #f8f9fa; padding: 0.5rem 0.75rem; border-radius: 6px; line-height: 1.5; }

    .sub-pricing { text-align: right; min-width: 180px; }
    .price-row { display: flex; justify-content: space-between; gap: 1rem; font-size: 0.85rem; margin-bottom: 0.35rem; }
    .price-row .label { color: #888; }
    .price-row .value { font-weight: 600; }
    .price-divider { border-top: 1px solid #e2e8f0; margin: 0.4rem 0; }
    .savings-tag {
      display: inline-block; padding: 0.35rem 0.65rem; border-radius: 6px;
      font-size: 0.85rem; font-weight: 700; margin-top: 0.5rem;
    }
    .savings-positive { background: #d4edda; color: #155724; }
    .savings-negative { background: #f8d7da; color: #721c24; }

    .error-msg { background: #fff5f5; color: #c53030; padding: 1rem 1.25rem; border-radius: 8px; margin-top: 1.5rem; border: 1px solid #feb2b2; }
    .no-results { background: #fffbeb; color: #92400e; padding: 1rem 1.25rem; border-radius: 8px; margin-top: 1.5rem; border: 1px solid #fde68a; }

    @media (max-width: 640px) {
      .form-grid { grid-template-columns: 1fr; }
      .sub-card { grid-template-columns: 1fr; }
      .sub-pricing { text-align: left; }
    }
  </style>
</head>
<body>
  <div class="header">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5"/></svg>
    <h1>Product Substitution Finder</h1>
    <span>Powered by Gemini + ChromaDB</span>
  </div>

  <div class="container">
    <div class="form-card">
      <h2>Describe the product you want to substitute</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>Product Name *</label>
          <input type="text" id="name" placeholder="e.g. Copy Paper Letter Size" />
        </div>
        <div class="form-group">
          <label>Supercategory *</label>
          <select id="supercategory">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Description</label>
          <textarea id="description" placeholder="e.g. 8.5 x 11 inches white copy paper, 20lb weight"></textarea>
        </div>
        <div class="form-group">
          <label>Category *</label>
          <select id="category">
            <option value="">Select supercategory first</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quantity *</label>
          <input type="number" id="quantity" placeholder="e.g. 500" min="0" step="any" />
        </div>
        <div class="form-group">
          <label>Quantity Unit</label>
          <input type="text" id="quantity_unit" placeholder="e.g. Sheets, Roll, Box" />
        </div>
        <div class="form-group">
          <label>Unit Price Paid ($)</label>
          <input type="number" id="unit_price" placeholder="e.g. 60.00 per case" min="0" step="0.01" />
        </div>
        <div class="form-group">
          <label>Total Amount Paid ($)</label>
          <input type="number" id="total_price" placeholder="e.g. 1200.00 for all units" min="0" step="0.01" />
        </div>
      </div>
      <button class="btn btn-primary" id="submitBtn" onclick="findSubstitutes()">Find Substitutes</button>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <span>Searching for substitutes and calculating savings...</span>
    </div>

    <div id="results"></div>
  </div>

  <script>
    const API = 'http://localhost:8000';
    let categoriesData = [];

    async function loadCategories() {
      try {
        const res = await fetch(`${API}/categories`);
        categoriesData = await res.json();
        const supercats = [...new Set(categoriesData.map(c => c.supercategory))].sort();
        const sel = document.getElementById('supercategory');
        sel.innerHTML = '<option value="">-- Select --</option>' +
          supercats.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch (e) {
        document.getElementById('supercategory').innerHTML = '<option value="">Failed to load</option>';
      }
    }

    document.getElementById('supercategory').addEventListener('change', function() {
      const cats = categoriesData.filter(c => c.supercategory === this.value).map(c => c.category).sort();
      const sel = document.getElementById('category');
      sel.innerHTML = cats.length
        ? '<option value="">-- Select --</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('')
        : '<option value="">No categories</option>';
    });

    async function findSubstitutes() {
      const name = document.getElementById('name').value.trim();
      const supercategory = document.getElementById('supercategory').value;
      const category = document.getElementById('category').value;
      const quantity = parseFloat(document.getElementById('quantity').value);
      const unit_price = parseFloat(document.getElementById('unit_price').value) || 0;
      const total_price = parseFloat(document.getElementById('total_price').value) || 0;

      if (!name || !supercategory || !category || !quantity) {
        alert('Please fill in all required fields (name, supercategory, category, quantity).');
        return;
      }

      const payload = {
        name,
        description: document.getElementById('description').value.trim(),
        supercategory,
        category,
        quantity,
        quantity_unit: document.getElementById('quantity_unit').value.trim(),
        unit_price,
        total_price,
      };

      const btn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');

      btn.disabled = true;
      loading.classList.add('active');
      results.innerHTML = '';

      try {
        const res = await fetch(`${API}/substitute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const err = await res.json();
          if (res.status === 429) {
            btn.disabled = true;
            btn.textContent = 'Limit Reached';
          }
          results.innerHTML = `<div class="error-msg">${err.detail || 'Request failed.'}</div>`;
          return;
        }

        const data = await res.json();
        if (data.requests_remaining !== undefined) {
          btn.textContent = `Find Substitutes (${data.requests_remaining} left)`;
        }
        renderResults(data);
      } catch (e) {
        results.innerHTML = `<div class="error-msg">Could not connect to API. Is the server running?</div>`;
      } finally {
        btn.disabled = false;
        loading.classList.remove('active');
      }
    }

    function renderResults(data) {
      const el = document.getElementById('results');

      if (!data.substitutes || data.substitutes.length === 0) {
        el.innerHTML = `<div class="no-results">No substitutes found. Try a different category or description.</div>`;
        return;
      }

      const src = data.source_item;
      const hasPricing = src.unit_price > 0 || src.total_price > 0;

      let sourceBadge = `Source: ${src.name} &mdash; ${src.quantity} ${src.quantity_unit || 'units'}`;
      if (hasPricing) {
        if (src.unit_price > 0) sourceBadge += ` @ $${src.unit_price.toFixed(2)}/unit`;
        if (src.total_price > 0) sourceBadge += ` = $${src.total_price.toFixed(2)} total`;
      }

      let html = `
        <div class="results">
          <div class="results-header">
            <h2>Top ${data.substitutes.length} Substitutes${hasPricing ? '' : ' (Quote)'}</h2>
            <div class="source-badge">${sourceBadge}</div>
          </div>
          <div class="meta-line">${data.candidates_evaluated} candidates evaluated from ${src.supercategory} &gt; ${src.category}</div>
      `;

      for (const sub of data.substitutes) {
        const hasSavings = sub.savings !== null && sub.savings !== undefined;

        let pricingHtml = '';
        pricingHtml += `<div class="price-row"><span class="label">Our Unit Price</span><span class="value">$${sub.our_unit_price.toFixed(2)}</span></div>`;

        if (hasSavings) {
          pricingHtml += `<div class="price-row"><span class="label">Your Unit Price</span><span class="value">$${sub.their_unit_price.toFixed(2)}</span></div>`;
        }

        pricingHtml += `<div class="price-divider"></div>`;
        pricingHtml += `<div class="price-row"><span class="label">Qty Needed</span><span class="value">&times;${sub.qty_needed}</span></div>`;
        pricingHtml += `<div class="price-row"><span class="label">Our Total</span><span class="value">$${sub.our_total_spend.toFixed(2)}</span></div>`;

        if (hasSavings) {
          pricingHtml += `<div class="price-row"><span class="label">Your Total</span><span class="value">$${sub.their_total_spend.toFixed(2)}</span></div>`;
          const savingsPositive = sub.savings >= 0;
          const savingsClass = savingsPositive ? 'savings-positive' : 'savings-negative';
          const savingsLabel = savingsPositive ? 'You save' : 'Costs more';
          const savingsAbs = Math.abs(sub.savings).toFixed(2);
          const savingsPctAbs = Math.abs(sub.savings_percentage).toFixed(1);
          pricingHtml += `<div class="savings-tag ${savingsClass}">${savingsLabel}: $${savingsAbs} (${savingsPctAbs}%)</div>`;
        } else {
          pricingHtml += `<div class="savings-tag savings-positive">Quote: $${sub.our_total_spend.toFixed(2)}</div>`;
        }

        html += `
          <div class="sub-card">
            <div class="rank-badge">${sub.rank}</div>
            <div class="sub-info">
              <h3>${sub.product_name}</h3>
              <div class="sub-meta">
                <span class="tag">SKU: ${sub.sku}</span>
                <span class="tag">${sub.candidate_uom}</span>
                <span class="tag">${sub.unit_type}</span>
                <span class="tag">Qty needed: ${sub.qty_needed}</span>
              </div>
              <div class="sub-reason">${sub.reason}</div>
              <div class="sub-notes">${sub.comparison_notes}</div>
            </div>
            <div class="sub-pricing">
              ${pricingHtml}
            </div>
          </div>
        `;
      }

      html += '</div>';
      el.innerHTML = html;
    }

    loadCategories();
  </script>
</body>
</html>
